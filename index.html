<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Field Book – Table First (QAQC GPS)</title>
  <style>
    :root{--pad:8px;--radius:12px;--accent:#0A84FF;--text:#111314;--separator:#E5E5EA;--bg:#FFFFFF;--bg-soft:#F9F9FB;--shadow:0 8px 24px rgba(0,0,0,0.06)}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Helvetica, Arial, sans-serif;font-size:14px}
    header{padding:var(--pad)}
    .wrap{max-width:1200px;margin:0 auto;padding:0 12px}
    .card{background:var(--bg);padding:var(--pad);margin:var(--pad) auto;border-radius:var(--radius);box-shadow:var(--shadow)}
    input,button{font-size:14px;border-radius:10px;border:1px solid var(--separator);background:var(--bg);color:var(--text);padding:8px 10px;transition:box-shadow .15s ease, background .15s ease}
    button{cursor:pointer;font-weight:600;flex:1}
    button.primary{background:#ffd400}
    button.ghost{background:var(--bg)}
    button:hover{background:#F2F2F7}
    button:active{background:#E5E5EA}
    input:focus,button:focus{outline:none;box-shadow:0 0 0 2px var(--accent)}
    .row{display:flex;gap:6px;flex-wrap:wrap;align-items:flex-end}
    .row>div{flex:1 1 140px}
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;font-size:13px;background:var(--bg);border:1px solid var(--separator);border-radius:12px;overflow:hidden}
    thead th{position:sticky;top:0;background:var(--bg-soft);padding:8px;font-weight:600;border-bottom:1px solid var(--separator);box-shadow:0 1px 0 var(--separator)}
    th,td{border-bottom:1px solid var(--separator);padding:8px;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    td.ro{background:#FAFAFC;font-weight:600}
    td[contenteditable="true"]{background:#F0F8FF; /* soft blue hue */}
    td[contenteditable="true"]:focus{outline:2px solid var(--accent);background:#E6F0FF}
    .small{font-size:11px;opacity:.9}
    .chip{padding:2px 8px;background:#fff;font-weight:600}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .gps-green{color:#34C759;font-weight:600}
    .gps-yellow{color:#FFCC00;font-weight:600}
    .gps-red{color:#FF3B30;font-weight:600}

  @media (max-width: 600px){
    .wrap{max-width:100%}
    .row{flex-direction:column; align-items:stretch}
    .row>div{flex:1 1 auto; width:100%}
    label{display:block; margin-bottom:4px; font-weight:600}
    input{width:100%}
    .btnbar{display:flex; flex-direction:row; gap:4px; margin-top:4px}
    table{font-size:12px}
    th, td{padding:4px}
    th:nth-child(1){width:50px}
    th:nth-child(2){width:50px}
    th:nth-child(3){width:60px}
    th:nth-child(4){width:50px}
    th:nth-child(5){width:70px}
    th:nth-child(6){width:65px}
  }
  @media (min-width: 900px){
    body{font-size:16px}
    input,button{font-size:16px}
    table{font-size:14px}
    .wrap{max-width:1280px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header class="card">
    <div class="row">
      <div><label>Job Title<br><input id="jobTitle" placeholder="Edgemont Stage 16" /></label></div>
      <div><label>Date of Survey<br><input id="dateOfSurvey" type="date" /></label></div>
    </div>
    <div class="row" style="margin-top:6px">
      <div><label>Station<br><input id="station" placeholder="266" /></label></div>
      <div><label>Elevation<br><input id="knownElev" type="number" step="0.001" placeholder="693.274" /></label></div>
      <div class="btnbar">
        <button id="addBs" class="ghost">Add BS</button>
        <button id="addFs" class="ghost">Add FS</button>
        <button id="newSetup" class="ghost">New Setup</button>
      </div>
    </div>
  </header>

  <section class="card">
    <div class="small" style="margin-bottom:6px">HI avg: <span id="hiAvg">—</span></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>ST</th>
          <th>BS</th>
          <th>HI</th>
          <th>FS</th>
          <th>ELEV</th>
          <th>GPS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="small">GPS QA: <span class="gps-green">≤ 0.030 m</span> • <span class="gps-yellow">≤ 0.040 m</span> • <span class="gps-red">&gt; 0.040 m</span></div>
  </section>
</div>

<script>
(() => {
  let setupId = 1;
  let rows = [];

  const $ = id => document.getElementById(id);
  const fmt = n => (n==null||isNaN(n) ? '' : Number(n).toFixed(3));

  $("dateOfSurvey").valueAsNumber = Date.now() - (new Date()).getTimezoneOffset()*60000;

  if(localStorage.fieldBookData){
    try {
      const saved = JSON.parse(localStorage.fieldBookData);
      rows = saved.rows || [];
      setupId = saved.setupId || 1;
      $("jobTitle").value = saved.jobTitle || '';
      $("dateOfSurvey").value = saved.dateOfSurvey || $("dateOfSurvey").value;
    }catch(e){console.warn("cache load failed",e)}
  }

  function hiStats(){
    const bsRows = rows.filter(r=>r.setupId===setupId && r.type==='BS' && !isNaN(r.hi));
    if(bsRows.length===0) return {avg:null};
    const his = bsRows.map(r=>r.hi);
    const avg = his.reduce((a,b)=>a+b,0)/his.length;
    return {avg};
  }

  function refreshHeader(){
    const s = hiStats();
    $("hiAvg").textContent = fmt(s.avg);
  }

  function saveCache(){
    const data = {rows, setupId, jobTitle:$("jobTitle").value, dateOfSurvey:$("dateOfSurvey").value};
    localStorage.fieldBookData = JSON.stringify(data);
  }

  function drawTable(){
    const tb = document.querySelector('#tbl tbody');
    tb.innerHTML='';
    rows.forEach((r) => {
      const tr = document.createElement('tr');
      const tdSt = document.createElement('td');
      tdSt.textContent = r.station || '';

      const tdBs = document.createElement('td');
      if(r.type==='BS'){
        tdBs.contentEditable = true; tdBs.textContent = fmt(r.bs);
        tdBs.onfocus = () => { setTimeout(()=>document.execCommand('selectAll',false,null),0); };
        tdBs.oninput = () => { r.bs = parseFloat(tdBs.textContent); r.hi = (!isNaN(r.bs) && !isNaN(r.knownElev)) ? (r.knownElev + r.bs) : null; tdHi.textContent = fmt(r.hi); refreshHeader(); saveCache(); };
      } else { tdBs.textContent = ''; }

      const tdHi = document.createElement('td');
      tdHi.className = 'ro'; tdHi.textContent = fmt(r.hi);

      const tdFs = document.createElement('td');
      if(r.type==='FS'){
        tdFs.contentEditable = true; tdFs.textContent = fmt(r.fs);
        tdFs.onfocus = () => { setTimeout(()=>document.execCommand('selectAll',false,null),0); };
        tdFs.oninput = () => { r.fs = parseFloat(tdFs.textContent); const s = hiStats(); r.elev = (!isNaN(r.fs) && !isNaN(s.avg)) ? (s.avg - r.fs) : r.elev; tdElev.textContent = fmt(r.elev); saveCache(); };
      } else { tdFs.textContent = ''; }

      const tdElev = document.createElement('td');
      tdElev.className = 'ro'; tdElev.textContent = fmt(r.elev);

      const tdGps = document.createElement('td');
      tdGps.contentEditable = true; tdGps.textContent = fmt(r.gps);
      tdGps.onfocus = () => { setTimeout(()=>document.execCommand('selectAll',false,null),0); };
      tdGps.oninput = () => { r.gps = parseFloat(tdGps.textContent); updateGps(); saveCache(); };
      function updateGps(){
        const diff = (!isNaN(r.gps) && !isNaN(r.elev)) ? Math.abs(r.gps - r.elev) : NaN;
        tdGps.className = '';
        if(!isNaN(diff)){
          if(diff <= 0.030) tdGps.classList.add('gps-green');
          else if(diff <= 0.040) tdGps.classList.add('gps-yellow');
          else tdGps.classList.add('gps-red');
        }
      }
      updateGps();

      tr.append(tdSt, tdBs, tdHi, tdFs, tdElev, tdGps);
      tb.appendChild(tr);
    });
    saveCache();
  }

  $("addBs").onclick = () => {
    const st = $("station").value.trim();
    const known = parseFloat($("knownElev").value);
    if(!st){ alert('Enter Station.'); return; }
    rows.push({station:st, type:'BS', knownElev:isNaN(known)? null : known, bs:null, hi:null, fs:null, elev:known||null, gps:null, setupId});
    $("station").value=''; $("knownElev").value='';
    drawTable(); refreshHeader();
  };

  $("addFs").onclick = () => {
    const st = $("station").value.trim();
    if(!st){ alert('Enter Station.'); return; }
    rows.push({station:st, type:'FS', knownElev:null, bs:null, hi:null, fs:null, elev:null, gps:null, setupId});
    $("station").value=''; $("knownElev").value='';
    drawTable(); refreshHeader();
  };

  $("newSetup").onclick = () => {
    const lastElevRow = [...rows].reverse().find(r=>!isNaN(r.elev));
    const carried = lastElevRow ? lastElevRow.elev : null;
    setupId += 1; refreshHeader();
    if(carried!=null){
      rows.push({station:'TP', type:'BS', knownElev:carried, bs:null, hi:null, fs:null, elev:carried, gps:null, setupId});
    }
    drawTable(); refreshHeader();
  };

  refreshHeader(); drawTable();
})();
</script>
</body>
</html>
