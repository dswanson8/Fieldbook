(function(){const APP_VERSION='2025-11-11';const STORAGE_KEY='dfb_v3_state';const GRADE_SPOTS_KEY='dfb_grade_spots_v1';const INV_DROP_KEY='dfb_inv_drop_v1';const GPS_DROP_KEY='dfb_gps_drop_v1';const els={title:byId('jobTitle'),date:byId('jobDate'),tabs:byId('setupTabs'),gridBody:byId('gridBody'),btnNewSetup:byId('newSetupBtn'),btnAddBs:byId('addBsBtn'),btnAddFs:byId('addFsBtn'),btnLock:byId('lockToggle'),btnExportAll:byId('exportAllBtn'),btnReset:byId('resetBtn'),aggMedian:byId('aggMedian'),aggMean:byId('aggMean'),summary:byId('summary'),toolsBtn:byId('toolsBtn'),toolsSheet:byId('toolsSheet'),toolsBackdrop:byId('toolsBackdrop'),toolsClose:byId('toolsClose'),scStartSta:byId('scStartSta'),scEndSta:byId('scEndSta'),scDStart:byId('scDStart'),scDEnd:byId('scDEnd'),scAStart:byId('scAStart'),scAEnd:byId('scAEnd'),scLen:byId('scLen'),scResults:byId('scResults'),scCompute:byId('scCompute'),scClear:byId('scClear'),scSetsBar:byId('scSetsBar'),gradeSpotsBtn:byId('gradeSpotsBtn'),gradeSpotsSheet:byId('gradeSpotsSheet'),gradeSpotsBackdrop:byId('gradeSpotsBackdrop'),gradeSpotsClose:byId('gradeSpotsClose'),invDrop:byId('invDrop'),gpsDrop:byId('gpsDrop'),gradeSpotsBody:byId('gradeSpotsBody'),addGradeRowBtn:byId('addGradeRowBtn'),clearGradeRowsBtn:byId('clearGradeRowsBtn'),asbPickerSheet:byId('asbPickerSheet'),asbPickerList:byId('asbPickerList'),asbPickerClose:byId('asbPickerClose'),slcStart:byId('slcStart'),slcEnd:byId('slcEnd'),slcSlope:byId('slcSlope'),slcLen:byId('slcLen'),slcResults:byId('slcResults'),slcCompute:byId('slcCompute'),slcClear:byId('slcClear'),existingBsBar:byId('existingBsBar'),btnAddExistingBs:byId('addExistingBsBtn'),bsPickerSheet:byId('bsPickerSheet'),bsPickerBackdrop:byId('bsPickerBackdrop'),bsPickerClose:byId('bsPickerClose'),bsPickerList:byId('bsPickerList'),bsPickerUse:byId('bsPickerUse'),bsPickerCancel:byId('bsPickerCancel'),};function toast(msg){const t=document.createElement('div');t.textContent=msg;t.style.cssText=`
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9999;
            opacity: 0;
            text-align: center;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        `;document.body.appendChild(t);requestAnimationFrame(()=>{t.style.opacity=1;t.style.transform='translateX(-50%) translateY(-4px)'});setTimeout(()=>{t.style.opacity=0;t.style.transform='translateX(-50%) translateY(0)';setTimeout(()=>t.remove(),200)},1400)}
const state=loadState()||{meta:{title:'',date:todayISO(),thresholds:{green:0.030,yellow:0.040},appVersion:APP_VERSION},settings:{useMedian:!0},setups:[],active:0,};if(!Array.isArray(state.gradeSpots))state.gradeSpots=[];els.title.value=state.meta.title;els.date.value=state.meta.date;els.aggMedian.checked=!!state.settings.useMedian;els.aggMean.checked=!state.settings.useMedian;els.title.addEventListener('input',commitMeta);els.date.addEventListener('input',commitMeta);els.btnNewSetup.addEventListener('click',()=>{addSetup();render();saveState()});els.btnAddBs.addEventListener('click',()=>{addRow('BS');render();saveState()});els.btnAddFs.addEventListener('click',()=>{addRow('FS');render();saveState()});els.btnLock.addEventListener('click',()=>{toggleLock();render();saveState()});els.btnExportAll.addEventListener('click',exportAllPrintable);els.btnReset.addEventListener('click',hardReset);els.toolsBtn?.addEventListener('click',openTools);els.toolsBackdrop?.addEventListener('click',closeTools);els.toolsClose?.addEventListener('click',closeTools);els.slcCompute?.addEventListener('click',computeSlopeSolve);els.slcClear?.addEventListener('click',clearSlopeSolve);els.addGradeRowBtn?.addEventListener('click',()=>{addGradeRow();renderGradeSpots();saveGradeSpots()});els.clearGradeRowsBtn?.addEventListener('click',()=>{if(confirm('Clear all grade spot rows?')){state.gradeSpots=[];renderGradeSpots();saveGradeSpots();toast('Cleared')}});els.invDrop?.addEventListener('blur',()=>{const v=sanitizeNumber((els.invDrop.value??'').trim());localStorage.setItem(INV_DROP_KEY,JSON.stringify(isNum(v)?v:null));renderGradeSpots()});els.gpsDrop?.addEventListener('blur',()=>{const v=sanitizeNumber((els.gpsDrop.value??'').trim());localStorage.setItem(GPS_DROP_KEY,JSON.stringify(isNum(v)?v:null));renderGradeSpots()});els.gradeSpotsBtn?.addEventListener('click',openGradeSpots);els.gradeSpotsBackdrop?.addEventListener('click',closeGradeSpots);els.gradeSpotsClose?.addEventListener('click',closeGradeSpots);els.asbPickerBackdrop?.addEventListener('click',closeAsbPicker);els.asbPickerClose?.addEventListener('click',closeAsbPicker);els.asbPickerList?.addEventListener('click',(e)=>{const btn=e.target.closest('button.bs-btn');if(!btn)return;const idx=Number(btn.dataset.targetIndex);if(!Number.isInteger(idx)||idx<0)return;const elev=sanitizeNumber(btn.dataset.elev);if(!isNum(elev))return toast('Invalid elevation');const gpsVal=sanitizeNumber(btn.dataset.gps);const row=state.gradeSpots[idx];row.asbTop=elev;row.gpsElev=isNum(gpsVal)?gpsVal:null;renderGradeSpots();saveGradeSpots();closeAsbPicker();toast('ASB elevation selected')});els.btnAddExistingBs?.addEventListener('click',openBsPicker);els.bsPickerBackdrop?.addEventListener('click',closeBsPicker);els.bsPickerClose?.addEventListener('click',closeBsPicker);els.bsPickerCancel?.addEventListener('click',closeBsPicker);els.bsPickerList?.addEventListener('click',(e)=>{const btn=e.target.closest('button.bs-btn');if(!btn)return;insertBsFromData(btn.dataset.station,sanitizeNumber(btn.dataset.elev))});els.aggMedian.addEventListener('change',()=>{const s=activeSetup();s.useMedian=!0;recompute(s);render();saveState()});els.aggMean.addEventListener('change',()=>{const s=activeSetup();s.useMedian=!1;recompute(s);render();saveState()});[els.scStartSta,els.scEndSta,els.scDStart,els.scDEnd,els.scAStart,els.scAEnd,els.scLen].filter(Boolean).forEach(inp=>{inp.addEventListener('blur',()=>{saveScFromInputs();saveState()})});els.scCompute?.addEventListener('click',()=>{saveScFromInputs();const s=activeScSet();if(!s)return;s.result=computeScFor(s);renderScResultsFrom(s.result);saveState();toast('Computed')});els.scClear?.addEventListener('click',()=>{const label=activeScSet()?.label||`Setup ${state.scActive + 1}`;state.scSets[state.scActive]=blankScSet(label);loadScIntoInputs();if(els.scResults)els.scResults.innerHTML='';saveState();toast('Cleared this setup')});if(state.setups.length===0)addSetup();render();function addSetup(){state.setups.push({locked:!1,rows:[],useMedian:!0});state.active=state.setups.length-1}
function activeSetup(){return state.setups[state.active]}
function getBsInsertIndex(s){if(!s||!Array.isArray(s.rows))return 0;if(s.rows.length===0)return 0;let last=-1;for(let i=0;i<s.rows.length;i++){if(s.rows[i].type==='BS')last=i;else break}
return last+1}
function addRow(kind){const s=activeSetup();if(s.locked){flash('Setup is locked');return}
if(kind==='BS'){s.rows.splice(getBsInsertIndex(s),0,{id:uid(),type:'BS',station:'',knownElev:null,bs:null,hi:null})}else{s.rows.push({id:uid(),type:'FS',station:'',fs:null,elev:null,gps:null,delta:null})}
recompute(s)}
function toggleLock(){activeSetup().locked=!activeSetup().locked}
function commitMeta(){state.meta.title=els.title.value.trim();state.meta.date=els.date.value||todayISO();state.meta.appVersion=APP_VERSION;saveState()}
function recomputeActive(){recompute(activeSetup())}
function recompute(setup){setup.rows.forEach(r=>{if(r.type==='BS'){if(isNum(r.knownElev)&&isNum(r.bs))r.hi=round3(r.knownElev+r.bs);else r.hi=null}});const his=setup.rows.filter(r=>r.type==='BS'&&isNum(r.hi)).map(r=>r.hi);const hiAgg=his.length?(setup.useMedian?median(his):mean(his)):null;setup.rows.forEach(r=>{if(r.type==='FS'){r.elev=(isNum(hiAgg)&&isNum(r.fs))?round3(hiAgg-r.fs):null;r.delta=(isNum(r.gps)&&isNum(r.elev))?round3(Math.abs(r.gps-r.elev)):null}})}
function render(){els.tabs.innerHTML='';state.setups.forEach((s,i)=>{const b=document.createElement('button');b.className='chip';b.textContent=`Setup ${i + 1}${s.locked ? ' ðŸ”’' : ''}`;if(i===state.active){b.style.borderColor='#60a5fa';b.style.color='#1d4ed8'}
b.addEventListener('click',()=>{state.active=i;render();saveState()});els.tabs.appendChild(b)});if(els.existingBsBar){if(state.active>0){els.existingBsBar.classList.remove('hidden')}else{els.existingBsBar.classList.add('hidden')}}
els.btnLock.textContent=activeSetup().locked?'ðŸ”“ Unlock':'ðŸ”’ Lock';els.gridBody.innerHTML='';const s=activeSetup();els.aggMedian.checked=!!s.useMedian;els.aggMean.checked=!s.useMedian;s.rows.forEach((r,idx)=>{const tr=document.createElement('tr');const tdSta=makeCell(r,'station',r.station,s.locked);attachRowDelete(tdSta,s,idx);tr.appendChild(tdSta);tr.appendChild(r.type==='BS'?makeCell(r,'bs',r.bs,s.locked):tdDim());tr.appendChild(makeCalc(r.hi));tr.appendChild(r.type==='FS'?makeCell(r,'fs',r.fs,s.locked):tdDim());tr.appendChild(r.type==='BS'?makeCell(r,'knownElev',r.knownElev,s.locked):makeCalc(r.elev));if(r.type==='FS'){const tdGps=makeCell(r,'gps',r.gps,s.locked);if(isNum(r.delta)){const thr=state.meta.thresholds;tdGps.classList.add(r.delta<=thr.green?'qa-green':r.delta<=thr.yellow?'qa-yellow':'qa-red')}
tr.appendChild(tdGps)}else{tr.appendChild(tdDim())}
els.gridBody.appendChild(tr)});updateSummary()}
loadGradeSpots();renderGradeSpots();function attachRowDelete(td,setup,idx){let timer=null;const start=()=>{timer=setTimeout(()=>{if(setup.locked)return flash('Setup is locked');if(confirm('Delete this row?')){setup.rows.splice(idx,1);recompute(setup);render();saveState()}},600)};const clear=()=>{if(timer){clearTimeout(timer);timer=null}};td.addEventListener('touchstart',start,{passive:!0});td.addEventListener('touchend',clear);td.addEventListener('touchmove',clear);td.addEventListener('mousedown',start);td.addEventListener('mouseup',clear);td.addEventListener('mouseleave',clear);td.addEventListener('contextmenu',(e)=>{e.preventDefault();if(setup.locked)return flash('Setup is locked');if(confirm('Delete this row?')){setup.rows.splice(idx,1);recompute(setup);render();saveState()}})}
function tdDim(){const td=document.createElement('td');td.textContent='â€”';td.className='cell-calc';return td}
function makeCalc(value,delta){const td=document.createElement('td');td.className='cell-calc';td.textContent=isNum(value)?num3(value):'â€”';if(isNum(delta)){if(delta<=0.030)td.classList.add('qa-green');else if(delta<=0.040)td.classList.add('qa-yellow');else td.classList.add('qa-red')}
return td}
function makeCell(row,field,value,locked){const td=document.createElement('td');const editable=isEditableField(row,field)&&!locked;if(!editable){td.className='cell-calc';if(isNum(value)){td.textContent=num3(value)}else{td.textContent=(value??'')}
return td}
td.className='cell-edit';if(field==='station'){const input=document.createElement('input');input.type='text';input.className='cell-input';input.inputMode='text';input.autocapitalize='characters';input.spellcheck=!1;input.value=(value??'').toString();input.addEventListener('blur',()=>{row.station=input.value.trim();saveState()});td.appendChild(input);return td}
const input=document.createElement('input');input.type='text';input.className='cell-input';input.inputMode='decimal';input.enterKeyHint='next';input.autocorrect='off';input.autocomplete='off';input.spellcheck=!1;input.value=isNum(value)?String(value):(value??'');input.addEventListener('blur',()=>{const raw=input.value.trim();const v=sanitizeNumber(raw);let value=v;if(v!==null){const typedHasDecimal=/[.,]/.test(raw);if(!typedHasDecimal){value=v/1000}}
row[field]=(value===null?null:value);recompute(activeSetup());render();saveState()});td.appendChild(input);return td}
function isEditableField(row,field){if(field==='station')return!0;if(row.type==='BS')return(field==='bs'||field==='knownElev');if(row.type==='FS')return(field==='fs'||field==='gps');return!1}
function updateSummary(){const lines=state.setups.map((s,i)=>{const bsRows=s.rows.filter(r=>r.type==='BS');const his=bsRows.filter(r=>isNum(r.hi)).map(r=>r.hi);const med=his.length?median(his):null;const avg=his.length?mean(his):null;const medPart=s.useMedian?`<span class="hi-active">Median HI: <b>${isNum(med) ? num3(med) : 'â€”'}</b></span>`:`Median HI: <b>${isNum(med) ? num3(med) : 'â€”'}</b>`;const avgPart=!s.useMedian?`<span class="hi-active">Mean HI: <b>${isNum(avg) ? num3(avg) : 'â€”'}</b></span>`:`Mean HI: <b>${isNum(avg) ? num3(avg) : 'â€”'}</b>`;return `Setup ${i + 1} â€¢ BS: <b>${bsRows.length}</b> â€¢ ${medPart} â€¢ ${avgPart}`});els.summary.innerHTML=lines.join('<br>')}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function exportAllPrintable(){const thr=state.meta.thresholds;const title=state.meta.title||'Field Book';const date=state.meta.date||todayISO();const fmt=v=>isNum(v)?num3(v):'â€”';const sections=state.setups.map((s,i)=>{const his=s.rows.filter(r=>r.type==='BS'&&isNum(r.hi)).map(r=>r.hi);const med=his.length?median(his):null;const avg=his.length?mean(his):null;const mode=s.useMedian?'Median':'Mean';const rowsHtml=s.rows.map(r=>{const tds=[];tds.push(`<td>${escapeHtml(r.station ?? '')}</td>`);tds.push(`<td>${r.type === 'BS' ? fmt(r.bs) : 'â€”'}</td>`);tds.push(`<td>${r.type === 'BS' ? fmt(r.hi) : 'â€”'}</td>`);tds.push(`<td>${r.type === 'FS' ? fmt(r.fs) : 'â€”'}</td>`);tds.push(`<td>${r.type === 'BS' ? fmt(r.knownElev) : (r.type === 'FS' ? fmt(r.elev) : 'â€”')}</td>`);let gpsHtml=r.type==='FS'?fmt(r.gps):'â€”';let cellStyle='';if(r.type==='FS'&&isNum(r.delta)){cellStyle=r.delta<=thr.green?' style="background:#dcfce7"':r.delta<=thr.yellow?' style="background:#fef3c7"':' style="background:#fee2e2"'}
tds.push(`<td${cellStyle}>${gpsHtml}</td>`);return `<tr>${tds.join('')}</tr>`}).join('');return `
            <section class="page">
                <h2>${escapeHtml(title)} â€” Setup ${i + 1}</h2>
                <div class="meta">
                <div><b>Date:</b> ${escapeHtml(date)}</div>
                <div><b>HI Mode:</b> ${mode}
                    &nbsp; <b>Median HI:</b> ${isNum(med) ? num3(med) : 'â€”'}
                    &nbsp; <b>Mean HI:</b> ${isNum(avg) ? num3(avg) : 'â€”'}</div>
                <div class="muted">GPS Î” thresholds: green â‰¤ ${num3(thr.green)} â€¢ yellow â‰¤ ${num3(thr.yellow)}</div>
                </div>
                <table>
                <thead><tr><th>STA</th><th>BS</th><th>HI</th><th>FS</th><th>ELEV</th><th>GPS</th></tr></thead>
                <tbody>${rowsHtml}</tbody>
                </table>
            </section>`}).join('');const html=`<!doctype html><html><head><meta charset="utf-8">
        <title>${escapeHtml(title)} â€” All Setups</title>
        <style>
            body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111;margin:24px;}
            h1,h2{margin:0 0 6px;}
            h2{font-size:18px;}
            .meta{margin:0 0 12px;color:#444}
            .muted{color:#555}
            table{width:100%;border-collapse:collapse;font-size:14px}
            th,td{border:1px solid #ccc;padding:6px 8px;text-align:left}
            th{background:#f3f4f6}
            .page{margin-bottom:24px;}
            @media print{
            body{margin:0.5in;}
            .page{page-break-after: always;}
            .page:last-of-type{page-break-after: auto;}
            button{display:none}
            }
        </style>
        </head>
        <body>
            <h1>${escapeHtml(title)} â€” All Setups</h1>
            ${sections}
            <button onclick="window.print()">Print / Save as PDF</button>
        </body></html>`;const win=window.open('','_blank');win.document.open();win.document.write(html);win.document.close()}
function saveState(andStatus){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));if(andStatus)setStatus('Saved');}catch(e){setStatus('Save failed');console.error(e)}}
function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return null;const s=JSON.parse(raw);if(!s?.meta?.appVersion||s.meta.appVersion!==APP_VERSION){try{localStorage.setItem(STORAGE_KEY+'_backup_'+Date.now(),raw)}catch(_){}
localStorage.removeItem(STORAGE_KEY);return null}
return s}catch(e){return null}}
if(!Array.isArray(state.scSets))state.scSets=[];if(typeof state.scActive!=='number')state.scActive=0;if(state.scSets.length===0){state.scSets.push(blankScSet('Setup 1'));state.scActive=0}
function blankScSet(label){return{label:label||'',startSta:'',endSta:'',dStart:null,dEnd:null,aStart:null,aEnd:null,len:null,result:null}}
function renderScTabs(){if(!els.scSetsBar)return;els.scSetsBar.innerHTML='';state.scSets.forEach((set,i)=>{const btn=document.createElement('button');btn.className='chip';btn.textContent=set.label||`Setup ${i + 1}`;if(i===state.scActive){btn.style.borderColor='#60a5fa';btn.style.color='#1d4ed8'}
btn.addEventListener('click',()=>{saveScFromInputs();state.scActive=i;loadScIntoInputs();renderScTabs();const s=activeScSet();if(s?.result){renderScResultsFrom(s.result)}else if(els.scResults){els.scResults.innerHTML=''}
saveState()});let holdTimer=null;const startHold=()=>{holdTimer=setTimeout(()=>{if(confirm(`Delete ${set.label || `Setup ${i+1}`}?`)){if(state.scSets.length>1){state.scSets.splice(i,1);if(state.scActive>=state.scSets.length){state.scActive=state.scSets.length-1}
renderScTabs();loadScIntoInputs();saveState();toast('Setup deleted')}else{toast('Cannot delete the only setup')}}},600)};const cancelHold=()=>{if(holdTimer){clearTimeout(holdTimer);holdTimer=null}};btn.addEventListener('touchstart',startHold,{passive:!0});btn.addEventListener('touchend',cancelHold);btn.addEventListener('touchmove',cancelHold);btn.addEventListener('mousedown',startHold);btn.addEventListener('mouseup',cancelHold);btn.addEventListener('mouseleave',cancelHold);btn.addEventListener('contextmenu',e=>{e.preventDefault();if(confirm(`Delete ${set.label || `Setup ${i+1}`}?`)){if(state.scSets.length>1){state.scSets.splice(i,1);if(state.scActive>=state.scSets.length){state.scActive=state.scSets.length-1}
renderScTabs();loadScIntoInputs();saveState();toast('Setup deleted')}else{toast('Cannot delete the only setup')}}});els.scSetsBar.appendChild(btn)});const addBtn=document.createElement('button');addBtn.className='chip';addBtn.textContent='+ Add Setup';addBtn.addEventListener('click',()=>{saveScFromInputs();const label=`Setup ${state.scSets.length + 1}`;state.scSets.push(blankScSet(label));state.scActive=state.scSets.length-1;loadScIntoInputs();renderScTabs();saveState();toast(`${label} added`)});els.scSetsBar.appendChild(addBtn)}
function loadScIntoInputs(){const s=activeScSet();if(!s)return;els.scStartSta&&(els.scStartSta.value=s.startSta??'');els.scEndSta&&(els.scEndSta.value=s.endSta??'');els.scDStart&&(els.scDStart.value=isNum(s.dStart)?num3(s.dStart):(s.dStart??''));els.scDEnd&&(els.scDEnd.value=isNum(s.dEnd)?num3(s.dEnd):(s.dEnd??''));els.scAStart&&(els.scAStart.value=isNum(s.aStart)?num3(s.aStart):(s.aStart??''));els.scAEnd&&(els.scAEnd.value=isNum(s.aEnd)?num3(s.aEnd):(s.aEnd??''));els.scLen&&(els.scLen.value=isNum(s.len)?String(s.len):(s.len??''))}
function saveScFromInputs(){const s=activeScSet();if(!s)return;s.startSta=(els.scStartSta?.value??'').trim();s.endSta=(els.scEndSta?.value??'').trim();s.dStart=mmToMeters(els.scDStart?.value);s.dEnd=mmToMeters(els.scDEnd?.value);s.aStart=mmToMeters(els.scAStart?.value);s.aEnd=mmToMeters(els.scAEnd?.value);s.len=sanitizeNumber((els.scLen?.value??'').trim())}
function hardReset(){if(confirm('Reset all data?')){localStorage.removeItem(STORAGE_KEY);location.reload()}}
function openTools(){const sheet=els.toolsSheet;if(!sheet){console.warn('Tools sheet not found in HTML');return}
sheet.classList.remove('hidden');sheet.setAttribute('aria-hidden','false');renderScTabs();loadScIntoInputs();const s=activeScSet();if(s?.result){renderScResultsFrom(s.result)}else if(els.scResults){els.scResults.innerHTML=''}}
function closeTools(){const sheet=els.toolsSheet;if(!sheet){console.warn('Tools sheet not found in HTML');return}
sheet.classList.add('hidden');sheet.setAttribute('aria-hidden','true')}
function mmToMeters(raw){const str=String(raw??'').trim();const v=sanitizeNumber(str);if(v===null)return null;return/[.,]/.test(str)?v:v/1000}
function fmtRatioFromPercent(pct){if(!isNum(pct)||pct===0)return'â€”';const r=Math.round(100/Math.abs(pct));return `1 in ${r}`}
function byId(id){return document.getElementById(id)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function uid(){return Math.random().toString(36).slice(2,9)}
function isNum(v){return typeof v==='number'&&isFinite(v)}
function round3(v){return Math.round(v*1000)/1000}
function num3(v){return(Math.round(v*1000)/1000).toFixed(3)}
function mean(a){return a.length?a.reduce((s,x)=>s+x,0)/a.length:null}
function median(a){if(!a.length)return null;const b=[...a].sort((x,y)=>x-y);const m=Math.floor(b.length/2);return b.length%2?b[m]:(b[m-1]+b[m])/2}
function sanitizeNumber(str){if(str==null)return null;let s=String(str).trim();if(!s)return null;s=s.replace(',','.');const cleaned=s.replace(/[^0-9+\-\.]/g,'');if(cleaned===''||cleaned==='-'||cleaned==='.'||cleaned==='+')return null;const n=Number(cleaned);return isFinite(n)?n:null}
function setStatus(msg){toast(msg)}
function flash(msg){toast(msg)}
function deltaMmText(asb,design){if(!isNum(asb)||!isNum(design))return'â€”';const mm=Math.round((asb-design)*1000);if(mm===0)return `<span class="delta-badge neutral">0 mm OK</span>`;const isHigh=mm>0;const arrow=isHigh?'â–²':'â–¼';const tone=isHigh?'green':'red';return `<span class="delta-badge ${tone}">${arrow} ${Math.abs(mm)} mm ${isHigh ? 'HIGH' : 'LOW'}</span>`}
function openBsPicker(){const options=gatherElevStations();if(!options.length){toast('No prior stations with elevation found');return}
els.bsPickerList.className='bs-grid';els.bsPickerList.innerHTML=options.map(opt=>`
            <button class="bs-btn" 
                    data-station="${escapeHtml(opt.station)}" 
                    data-elev="${opt.elev}">
            <div>${escapeHtml(opt.station || '(no STA)')}</div>
            <span class="bs-meta">Elev <span class="text-blue bold">${num3(opt.elev)}</span> â€¢ Setup ${opt.setup + 1} â€¢ ${opt.source}</span>
            </button>
        `).join('');els.bsPickerSheet.classList.remove('hidden');els.bsPickerSheet.setAttribute('aria-hidden','false')}
function closeBsPicker(){els.bsPickerSheet.classList.add('hidden');els.bsPickerSheet.setAttribute('aria-hidden','true')}
function gatherElevStations(){const out=[];state.setups.forEach((s,si)=>{if(si>=state.active)return;s.rows.forEach((r,ri)=>{if(r.type==='BS'&&isNum(r.knownElev)){out.push({setup:si,index:ri,station:r.station||'',elev:r.knownElev,source:'BS'})}
if(r.type==='FS'&&isNum(r.elev)){out.push({setup:si,index:ri,station:r.station||'',elev:r.elev,source:'FS'})}})});out.sort((a,b)=>(b.setup-a.setup)||(a.index-b.index));return out}
function insertBsFromPicker(){const checked=document.querySelector('input[name="bsPick"]:checked');if(!checked){flash('Select a station first');return}
const station=checked.getAttribute('data-station')||'';const elevStr=checked.getAttribute('data-elev');const elev=sanitizeNumber(elevStr);const s=activeSetup();if(s.locked){flash('Setup is locked');return}
s.rows.splice(getBsInsertIndex(s),0,{id:uid(),type:'BS',station:station,knownElev:isNum(elev)?elev:null,bs:null,hi:null});recompute(s);render();saveState();closeBsPicker();flash('Existing BS added')}
function insertBsFromData(station,elev){const s=activeSetup();if(s.locked)return toast('Setup is locked');s.rows.splice(getBsInsertIndex(s),0,{id:uid(),type:'BS',station:station||'',knownElev:isNum(elev)?elev:null,bs:null,hi:null});recompute(s);render();saveState();closeBsPicker();toast('Existing BS added')}
function readSlcInputs(){const start=mmToMeters(els.slcStart?.value);const end=mmToMeters(els.slcEnd?.value);const slope=sanitizeNumber((els.slcSlope?.value??'').trim());const len=sanitizeNumber((els.slcLen?.value??'').trim());return{start,end,slope,len}}
function countProvided(obj){return Object.values(obj).reduce((n,v)=>n+(isNum(v)?1:0),0)}
function computeSlopeSolve(){const bottom=mmToMeters(els.slcStart?.value);const top=mmToMeters(els.slcEnd?.value);const slope=sanitizeNumber((els.slcSlope?.value??'').trim());const len=sanitizeNumber((els.slcLen?.value??'').trim());const provided={bottom,top,slope,len};const n=Object.values(provided).reduce((c,v)=>c+(isNum(v)?1:0),0);if(n<3){els.slcResults.innerHTML='';toast('Provide any 3 fields; 1 will be solved');return}
if(n>3){els.slcResults.innerHTML='';toast('Please leave exactly 1 field blank');return}
let solved={bottom,top,slope,len};let solvedKey=null;if(!isNum(bottom)&&isNum(top)&&isNum(slope)&&isNum(len)&&len!==0){solved.bottom=top-(slope/100)*len;solvedKey='bottom'}else if(!isNum(top)&&isNum(bottom)&&isNum(slope)&&isNum(len)&&len!==0){solved.top=bottom+(slope/100)*len;solvedKey='top'}else if(!isNum(slope)&&isNum(bottom)&&isNum(top)&&isNum(len)&&len!==0){solved.slope=((top-bottom)/len)*100;solvedKey='slope'}else if(!isNum(len)&&isNum(bottom)&&isNum(top)&&isNum(slope)&&slope!==0){solved.len=(top-bottom)/(slope/100);solvedKey='len'}else{els.slcResults.innerHTML='';toast('Inputs inconsistent (check zero length or zero slope)');return}
const fmtM=v=>isNum(v)?`${num3(v)} m`:'â€”';const fmtP=v=>isNum(v)?`${num3(v)}%`:'â€”';const bold=(k,txt)=>(solvedKey===k?`<b>${txt}</b>`:txt);els.slcResults.innerHTML=`
            <div>${bold('bottom', `Bottom Elev:${fmtM(solved.bottom)}`)}</div>
            <div>${bold('top', `Top Elev:${fmtM(solved.top)}`)}</div>
            <div>${bold('slope', `Slope:${fmtP(solved.slope)}`)}</div>
            <div>${bold('len', `Length:${fmtM(solved.len)}`)}</div>
        `}
function clearSlopeSolve(){[els.slcStart,els.slcEnd,els.slcSlope,els.slcLen].forEach(i=>i&&(i.value=''));els.slcResults.innerHTML=''}
function loadGradeSpots(){try{const raw=localStorage.getItem(GRADE_SPOTS_KEY);if(raw){const rows=JSON.parse(raw);if(Array.isArray(rows))state.gradeSpots=rows}}catch(e){}
try{const raw=localStorage.getItem(INV_DROP_KEY);if(raw){const drop=JSON.parse(raw);if(isNum(drop)&&els.invDrop)els.invDrop.value=String(drop);}}catch(e){}
try{const raw=localStorage.getItem(GPS_DROP_KEY);if(raw){const drop=JSON.parse(raw);if(isNum(drop)&&els.gpsDrop)els.gpsDrop.value=String(drop);}}catch(e){}}
function saveGradeSpots(){try{localStorage.setItem(GRADE_SPOTS_KEY,JSON.stringify(state.gradeSpots))}catch(e){}}
function addGradeRow(){state.gradeSpots.push({sta:'',dInv:null,asbTop:null,gpsElev:null})}
function renderGradeSpots(){if(!els.gradeSpotsBody)return;if(!Array.isArray(state.gradeSpots))state.gradeSpots=[];const drop=sanitizeNumber((els.invDrop?.value??'').trim());const gpsDrop=sanitizeNumber((els.gpsDrop?.value??'').trim());els.gradeSpotsBody.innerHTML='';state.gradeSpots.forEach((r,i)=>{const tr=document.createElement('tr');const tdSta=cellEditText(r,'sta',r.sta,v=>{r.sta=v;saveGradeSpots()});attachGradeRowDelete(tdSta,i);tr.appendChild(tdSta);tr.appendChild(cellEditNumber(r,'dInv',r.dInv,v=>{r.dInv=v;saveGradeSpots();renderGradeSpots()},!0));const tdTop=document.createElement('td');tdTop.className='cell-edit';tdTop.style.display='flex';tdTop.style.flexDirection='column';tdTop.style.alignItems='center';tdTop.style.padding='4px';const inpTop=document.createElement('input');inpTop.type='text';inpTop.className='cell-input cell-input--manual';inpTop.inputMode='decimal';inpTop.value=isNum(r.asbTop)?String(r.asbTop):(r.asbTop??'');inpTop.addEventListener('blur',()=>{const raw=inpTop.value.trim();const n=mmToMeters(raw);r.asbTop=n;saveGradeSpots();renderGradeSpots()});tdTop.appendChild(inpTop);const calcLine=document.createElement('div');calcLine.className='mini-hint';if(isNum(r.asbTop)&&isNum(drop)){const newInv=r.asbTop-drop;calcLine.innerHTML=`âˆ’ ${num3(drop)} = <b>${num3(newInv)}</b>`}else{calcLine.textContent='invert â€”'}
tdTop.appendChild(calcLine);const pickBtn=document.createElement('button');pickBtn.type='button';pickBtn.textContent='Pick';pickBtn.style.cssText='margin: 2px 0px 2px; padding:4px 18px;width:auto;font-size: 8px;';pickBtn.addEventListener('click',()=>openAsbPicker(i));tdTop.appendChild(pickBtn);tr.appendChild(tdTop);const tdDelta=document.createElement('td');tdDelta.className='cell-calc';let html='â€”';if(isNum(r.dInv)&&isNum(r.asbTop)&&isNum(drop)){const asbInv=r.asbTop-drop;html=deltaMmText(asbInv,r.dInv)}
tdDelta.innerHTML=html;tr.appendChild(tdDelta);const tdGps=document.createElement('td');tdGps.className='cell-calc';tdGps.style.display='flex';tdGps.style.flexDirection='column';tdGps.style.alignItems='center';tdGps.style.padding='4px';const gpsElevLine=document.createElement('div');gpsElevLine.className='mini-hint';if(isNum(r.gpsElev)){gpsElevLine.innerHTML=`GPS ${num3(r.gpsElev)}`}else{gpsElevLine.textContent='GPS â€”'}
tdGps.appendChild(gpsElevLine);const gpsCalcLine=document.createElement('div');gpsCalcLine.className='mini-hint';let gpsInv=null;if(isNum(r.gpsElev)&&isNum(gpsDrop)){gpsInv=r.gpsElev-gpsDrop;gpsCalcLine.innerHTML=`âˆ’ ${num3(gpsDrop)} = <b>${num3(gpsInv)}</b>`}else{gpsCalcLine.textContent='invert â€”'}
tdGps.appendChild(gpsCalcLine);const gpsDeltaLine=document.createElement('div');gpsDeltaLine.className='mini-hint';if(isNum(r.dInv)&&isNum(gpsInv)){gpsDeltaLine.innerHTML=deltaMmText(gpsInv,r.dInv)}else{gpsDeltaLine.textContent='Î” â€”'}
tdGps.appendChild(gpsDeltaLine);tr.appendChild(tdGps);els.gradeSpotsBody.appendChild(tr)})}
function attachGradeRowDelete(td,rowIndex){let timer=null;const doDelete=()=>{if(!Array.isArray(state.gradeSpots))return;if(rowIndex<0||rowIndex>=state.gradeSpots.length)return;if(!confirm('Delete this grade spot row?'))return;state.gradeSpots.splice(rowIndex,1);saveGradeSpots();renderGradeSpots()};const start=()=>{timer=setTimeout(()=>{timer=null;doDelete()},600)};const clear=()=>{if(timer){clearTimeout(timer);timer=null}};td.addEventListener('touchstart',start,{passive:!0});td.addEventListener('touchend',clear);td.addEventListener('touchmove',clear);td.addEventListener('mousedown',start);td.addEventListener('mouseup',clear);td.addEventListener('mouseleave',clear);td.addEventListener('contextmenu',(e)=>{e.preventDefault();doDelete()})}
function cellEditText(row,field,value,onCommit){const td=document.createElement('td');td.className='cell-edit';const inp=document.createElement('input');inp.type='text';inp.className='cell-input';inp.inputMode='text';inp.value=(value??'').toString();inp.addEventListener('blur',()=>onCommit(inp.value.trim()));td.appendChild(inp);return td}
function cellEditNumber(row,field,value,onCommit,allowMmShorthand){const td=document.createElement('td');td.className='cell-edit';const inp=document.createElement('input');inp.type='text';inp.className='cell-input cell-input--manual';inp.inputMode='decimal';inp.value=isNum(value)?String(value):(value??'');inp.addEventListener('blur',()=>{const raw=inp.value.trim();const n=allowMmShorthand?mmToMeters(raw):sanitizeNumber(raw);onCommit(n);renderGradeSpots()});td.appendChild(inp);return td}
function openGradeSpots(){els.gradeSpotsSheet.classList.remove('hidden');els.gradeSpotsSheet.setAttribute('aria-hidden','false');loadGradeSpots();renderGradeSpots()}
function closeGradeSpots(){els.gradeSpotsSheet.classList.add('hidden');els.gradeSpotsSheet.setAttribute('aria-hidden','true')}
let _gradeSpotTargetIndex=-1;function openAsbPicker(targetIndex){_gradeSpotTargetIndex=targetIndex;const options=gatherAsbElevStations();if(!options.length){return toast('No stations with elevation found')}
els.asbPickerList.className='bs-grid';els.asbPickerList.innerHTML=options.map(opt=>{const elevText=isNum(opt.elev)?num3(opt.elev):'â€”';const gpsText=isNum(opt.gps)?` â€¢ GPS ${num3(opt.gps)}`:'';return `
            <button class="bs-btn"
                    data-target-index="${_gradeSpotTargetIndex}"
                    data-station="${escapeHtml(opt.station)}"
                    data-elev="${isNum(opt.elev) ? opt.elev : ''}"
                    data-gps="${isNum(opt.gps) ? opt.gps : ''}">
            <div>${escapeHtml(opt.station || '(no STA)')}</div>
            <span class="bs-meta">Elev <span class="text-blue bold">${elevText}</span> â€¢ Setup ${opt.setup + 1} â€¢ ${opt.source}<span class="text-orange bold">${gpsText}</span></span>
            </button>
        `}).join('');els.asbPickerSheet.classList.remove('hidden');els.asbPickerSheet.setAttribute('aria-hidden','false')}
function closeAsbPicker(){els.asbPickerSheet.classList.add('hidden');els.asbPickerSheet.setAttribute('aria-hidden','true');_gradeSpotTargetIndex=-1}
function gatherAsbElevStations(){const out=[];state.setups.forEach((s,si)=>{s.rows.forEach((r,ri)=>{if(r.type==='FS'){const elev=isNum(r.elev)?r.elev:null;const gps=isNum(r.gps)?r.gps:null;if(elev!==null||gps!==null){out.push({setup:si,index:ri,station:r.station||'',elev,gps,source:'FS'})}}})});out.sort((a,b)=>(b.setup-a.setup)||(a.index-b.index));return out}
function computeScFor(set){const out={designSlope:null,designRatio:null,asbSlope:null,asbRatio:null,deltaSlope:null,deltaEnd:null};const len=(isNum(set.len)&&set.len!==0)?set.len:null;const slopeToRatio=(pct)=>{if(!isNum(pct)||pct===0)return null;const r=Math.abs(1/(pct/100));return `1 in ${Math.round(r)}`};if(len&&isNum(set.dStart)&&isNum(set.dEnd)){const ds=((set.dEnd-set.dStart)/len)*100;out.designSlope=round3(ds);out.designRatio=slopeToRatio(ds)}
if(len&&isNum(set.aStart)&&isNum(set.aEnd)){const as=((set.aEnd-set.aStart)/len)*100;out.asbSlope=round3(as);out.asbRatio=slopeToRatio(as)}
if(isNum(out.designSlope)&&isNum(out.asbSlope)){out.deltaSlope=round3(out.asbSlope-out.designSlope)}
if(isNum(set.dEnd)&&isNum(set.aEnd)){out.deltaEnd=round3(set.aEnd-set.dEnd)}
return out}
function renderScResultsFrom(out){const pct=v=>isNum(v)?`${num3(v)}%`:'â€”';const s=activeScSet&&activeScSet();const startBadge=(s&&isNum(s.aStart)&&isNum(s.dStart))?deltaMmText(s.aStart,s.dStart):'â€”';const endBadge=(s&&isNum(s.aEnd)&&isNum(s.dEnd))?deltaMmText(s.aEnd,s.dEnd):'â€”';if(els.scResults){els.scResults.innerHTML=`<div><b>Design Slope:</b> ${pct(out.designSlope)} ${out.designRatio ? `(${out.designRatio})` : ''}</div>
       <div><b>ASB Slope:</b> ${pct(out.asbSlope)} ${out.asbRatio ? `(${out.asbRatio})` : ''}</div>
       <div><b>Î” Slope:</b> ${pct(out.deltaSlope)}</div>
       <div><b>Î” Start Elev:</b> ${startBadge}</div>
       <div><b>Î” End Elev:</b> ${endBadge}</div>`}}
function activeScSet(){return state.scSets[state.scActive]}
renderScTabs();loadScIntoInputs();const s0=activeScSet();if(s0?.result)renderScResultsFrom(s0.result);})()