(function(){const APP_VERSION='2025-11-06-V4';const STORAGE_KEY='dfb_v3_state';const SLOPE_STORAGE_KEY='dfb_slopecalc_v1';const GRADE_SPOTS_KEY='dfb_grade_spots_v1';const INV_DROP_KEY='dfb_inv_drop_v1';const els={title:byId('jobTitle'),date:byId('jobDate'),tabs:byId('setupTabs'),gridBody:byId('gridBody'),btnNewSetup:byId('newSetupBtn'),btnAddBs:byId('addBsBtn'),btnAddFs:byId('addFsBtn'),btnLock:byId('lockToggle'),btnExportAll:byId('exportAllBtn'),btnReset:byId('resetBtn'),aggMedian:byId('aggMedian'),aggMean:byId('aggMean'),summary:byId('summary'),toolsBtn:byId('toolsBtn'),toolsSheet:byId('toolsSheet'),toolsBackdrop:byId('toolsBackdrop'),toolsClose:byId('toolsClose'),scStartSta:byId('scStartSta'),scEndSta:byId('scEndSta'),scDStart:byId('scDStart'),scDEnd:byId('scDEnd'),scAStart:byId('scAStart'),scAEnd:byId('scAEnd'),scLen:byId('scLen'),scResults:byId('scResults'),scCompute:byId('scCompute'),scClear:byId('scClear'),gradeSpotsBtn:byId('gradeSpotsBtn'),gradeSpotsSheet:byId('gradeSpotsSheet'),gradeSpotsBackdrop:byId('gradeSpotsBackdrop'),gradeSpotsClose:byId('gradeSpotsClose'),invDrop:byId('invDrop'),gradeSpotsBody:byId('gradeSpotsBody'),addGradeRowBtn:byId('addGradeRowBtn'),clearGradeRowsBtn:byId('clearGradeRowsBtn'),asbPickerSheet:byId('asbPickerSheet'),asbPickerList:byId('asbPickerList'),asbPickerClose:byId('asbPickerClose'),slcStart:byId('slcStart'),slcEnd:byId('slcEnd'),slcSlope:byId('slcSlope'),slcLen:byId('slcLen'),slcResults:byId('slcResults'),slcCompute:byId('slcCompute'),slcClear:byId('slcClear'),existingBsBar:byId('existingBsBar'),btnAddExistingBs:byId('addExistingBsBtn'),bsPickerSheet:byId('bsPickerSheet'),bsPickerBackdrop:byId('bsPickerBackdrop'),bsPickerClose:byId('bsPickerClose'),bsPickerList:byId('bsPickerList'),bsPickerUse:byId('bsPickerUse'),bsPickerCancel:byId('bsPickerCancel'),};function toast(msg){const t=document.createElement('div');t.textContent=msg;t.style.cssText=`
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9999;
            opacity: 0;
            text-align: center;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        `;document.body.appendChild(t);requestAnimationFrame(()=>{t.style.opacity=1;t.style.transform='translateX(-50%) translateY(-4px)'});setTimeout(()=>{t.style.opacity=0;t.style.transform='translateX(-50%) translateY(0)';setTimeout(()=>t.remove(),200)},1400)}
const state=loadState()||{meta:{title:'',date:todayISO(),thresholds:{green:0.030,yellow:0.040},appVersion:APP_VERSION},settings:{useMedian:!0},setups:[],active:0,};if(!Array.isArray(state.gradeSpots))state.gradeSpots=[];els.title.value=state.meta.title;els.date.value=state.meta.date;els.aggMedian.checked=!!state.settings.useMedian;els.aggMean.checked=!state.settings.useMedian;els.title.addEventListener('input',commitMeta);els.date.addEventListener('input',commitMeta);els.btnNewSetup.addEventListener('click',()=>{addSetup();render();saveState()});els.btnAddBs.addEventListener('click',()=>{addRow('BS');render();saveState()});els.btnAddFs.addEventListener('click',()=>{addRow('FS');render();saveState()});els.btnLock.addEventListener('click',()=>{toggleLock();render();saveState()});els.btnExportAll.addEventListener('click',exportAllPrintable);els.btnReset.addEventListener('click',hardReset);els.toolsBtn?.addEventListener('click',openTools);els.toolsBackdrop?.addEventListener('click',closeTools);els.toolsClose?.addEventListener('click',closeTools);els.scCompute?.addEventListener('click',computeSlopeCheck);els.scClear?.addEventListener('click',clearSlopeCheck);els.slcCompute?.addEventListener('click',computeSlopeSolve);els.slcClear?.addEventListener('click',clearSlopeSolve);els.addGradeRowBtn?.addEventListener('click',()=>{addGradeRow();renderGradeSpots();saveGradeSpots()});els.clearGradeRowsBtn?.addEventListener('click',()=>{if(confirm('Clear all grade spot rows?')){state.gradeSpots=[];renderGradeSpots();saveGradeSpots();toast('Cleared')}});els.invDrop?.addEventListener('blur',()=>{const v=sanitizeNumber((els.invDrop.value??'').trim());localStorage.setItem(INV_DROP_KEY,JSON.stringify(isNum(v)?v:null));renderGradeSpots()});els.gradeSpotsBtn?.addEventListener('click',openGradeSpots);els.gradeSpotsBackdrop?.addEventListener('click',closeGradeSpots);els.gradeSpotsClose?.addEventListener('click',closeGradeSpots);els.asbPickerBackdrop?.addEventListener('click',closeAsbPicker);els.asbPickerClose?.addEventListener('click',closeAsbPicker);els.asbPickerList?.addEventListener('click',(e)=>{const btn=e.target.closest('button.bs-btn');if(!btn)return;const idx=Number(btn.dataset.targetIndex);const elev=sanitizeNumber(btn.dataset.elev);if(!Number.isInteger(idx)||idx<0)return;if(!isNum(elev))return toast('Invalid elevation');state.gradeSpots[idx].asbTop=elev;renderGradeSpots();saveGradeSpots();closeAsbPicker();toast('ASB elevation selected')});els.btnAddExistingBs?.addEventListener('click',openBsPicker);els.bsPickerBackdrop?.addEventListener('click',closeBsPicker);els.bsPickerClose?.addEventListener('click',closeBsPicker);els.bsPickerCancel?.addEventListener('click',closeBsPicker);els.bsPickerList?.addEventListener('click',(e)=>{const btn=e.target.closest('button.bs-btn');if(!btn)return;insertBsFromData(btn.dataset.station,sanitizeNumber(btn.dataset.elev))});els.aggMedian.addEventListener('change',()=>{const s=activeSetup();s.useMedian=!0;recompute(s);render();saveState()});els.aggMean.addEventListener('change',()=>{const s=activeSetup();s.useMedian=!1;recompute(s);render();saveState()});if(state.setups.length===0)addSetup();render();function addSetup(){state.setups.push({locked:!1,rows:[],useMedian:!0});state.active=state.setups.length-1}
function activeSetup(){return state.setups[state.active]}
function addRow(kind){const s=activeSetup();if(s.locked){flash('Setup is locked');return}
if(kind==='BS'){s.rows.unshift({id:uid(),type:'BS',station:'',knownElev:null,bs:null,hi:null})}else{s.rows.push({id:uid(),type:'FS',station:'',fs:null,elev:null,gps:null,delta:null})}
recompute(s)}
function toggleLock(){activeSetup().locked=!activeSetup().locked}
function commitMeta(){state.meta.title=els.title.value.trim();state.meta.date=els.date.value||todayISO();state.meta.appVersion=APP_VERSION;saveState()}
function recomputeActive(){recompute(activeSetup())}
function recompute(setup){setup.rows.forEach(r=>{if(r.type==='BS'){if(isNum(r.knownElev)&&isNum(r.bs))r.hi=round3(r.knownElev+r.bs);else r.hi=null}});const his=setup.rows.filter(r=>r.type==='BS'&&isNum(r.hi)).map(r=>r.hi);const hiAgg=his.length?(setup.useMedian?median(his):mean(his)):null;setup.rows.forEach(r=>{if(r.type==='FS'){r.elev=(isNum(hiAgg)&&isNum(r.fs))?round3(hiAgg-r.fs):null;r.delta=(isNum(r.gps)&&isNum(r.elev))?round3(Math.abs(r.gps-r.elev)):null}})}
function render(){els.tabs.innerHTML='';state.setups.forEach((s,i)=>{const b=document.createElement('button');b.className='chip';b.textContent=`Setup ${i + 1}${s.locked ? ' ðŸ”’' : ''}`;if(i===state.active){b.style.borderColor='#60a5fa';b.style.color='#1d4ed8'}
b.addEventListener('click',()=>{state.active=i;render();saveState()});els.tabs.appendChild(b)});if(els.existingBsBar){if(state.active>0){els.existingBsBar.classList.remove('hidden')}else{els.existingBsBar.classList.add('hidden')}}
els.btnLock.textContent=activeSetup().locked?'ðŸ”“ Unlock':'ðŸ”’ Lock';els.gridBody.innerHTML='';const s=activeSetup();els.aggMedian.checked=!!s.useMedian;els.aggMean.checked=!s.useMedian;s.rows.forEach((r,idx)=>{const tr=document.createElement('tr');const tdSta=makeCell(r,'station',r.station,s.locked);attachRowDelete(tdSta,s,idx);tr.appendChild(tdSta);tr.appendChild(r.type==='BS'?makeCell(r,'bs',r.bs,s.locked):tdDim());tr.appendChild(makeCalc(r.hi));tr.appendChild(r.type==='FS'?makeCell(r,'fs',r.fs,s.locked):tdDim());tr.appendChild(r.type==='BS'?makeCell(r,'knownElev',r.knownElev,s.locked):makeCalc(r.elev));if(r.type==='FS'){const tdGps=makeCell(r,'gps',r.gps,s.locked);if(isNum(r.delta)){const thr=state.meta.thresholds;tdGps.classList.add(r.delta<=thr.green?'qa-green':r.delta<=thr.yellow?'qa-yellow':'qa-red')}
tr.appendChild(tdGps)}else{tr.appendChild(tdDim())}
els.gridBody.appendChild(tr)});updateSummary()}
loadGradeSpots();renderGradeSpots();function attachRowDelete(td,setup,idx){let timer=null;const start=()=>{timer=setTimeout(()=>{if(setup.locked)return flash('Setup is locked');if(confirm('Delete this row?')){setup.rows.splice(idx,1);recompute(setup);render();saveState()}},600)};const clear=()=>{if(timer){clearTimeout(timer);timer=null}};td.addEventListener('touchstart',start,{passive:!0});td.addEventListener('touchend',clear);td.addEventListener('touchmove',clear);td.addEventListener('mousedown',start);td.addEventListener('mouseup',clear);td.addEventListener('mouseleave',clear);td.addEventListener('contextmenu',(e)=>{e.preventDefault();if(setup.locked)return flash('Setup is locked');if(confirm('Delete this row?')){setup.rows.splice(idx,1);recompute(setup);render();saveState()}})}
function tdDim(){const td=document.createElement('td');td.textContent='â€”';td.className='cell-calc';return td}
function makeCalc(value,delta){const td=document.createElement('td');td.className='cell-calc';td.textContent=isNum(value)?num3(value):'â€”';if(isNum(delta)){if(delta<=0.030)td.classList.add('qa-green');else if(delta<=0.040)td.classList.add('qa-yellow');else td.classList.add('qa-red')}
return td}
function makeCell(row,field,value,locked){const td=document.createElement('td');const editable=isEditableField(row,field)&&!locked;if(!editable){td.className='cell-calc';if(isNum(value)){td.textContent=num3(value)}else{td.textContent=(value??'')}
return td}
td.className='cell-edit';if(field==='station'){const input=document.createElement('input');input.type='text';input.className='cell-input';input.inputMode='text';input.autocapitalize='characters';input.spellcheck=!1;input.value=(value??'').toString();input.addEventListener('blur',()=>{row.station=input.value.trim();saveState()});td.appendChild(input);return td}
const input=document.createElement('input');input.type='text';input.className='cell-input';input.inputMode='decimal';input.enterKeyHint='next';input.autocorrect='off';input.autocomplete='off';input.spellcheck=!1;input.value=isNum(value)?String(value):(value??'');input.addEventListener('blur',()=>{const raw=input.value.trim();const v=sanitizeNumber(raw);let value=v;if(v!==null){const typedHasDecimal=/[.,]/.test(raw);if(!typedHasDecimal){value=v/1000}}
row[field]=(value===null?null:value);recompute(activeSetup());render();saveState()});td.appendChild(input);return td}
function isEditableField(row,field){if(field==='station')return!0;if(row.type==='BS')return(field==='bs'||field==='knownElev');if(row.type==='FS')return(field==='fs'||field==='gps');return!1}
function updateSummary(){const lines=state.setups.map((s,i)=>{const bsRows=s.rows.filter(r=>r.type==='BS');const his=bsRows.filter(r=>isNum(r.hi)).map(r=>r.hi);const med=his.length?median(his):null;const avg=his.length?mean(his):null;const medPart=s.useMedian?`<span class="hi-active">Median HI: <b>${isNum(med) ? num3(med) : 'â€”'}</b></span>`:`Median HI: <b>${isNum(med) ? num3(med) : 'â€”'}</b>`;const avgPart=!s.useMedian?`<span class="hi-active">Mean HI: <b>${isNum(avg) ? num3(avg) : 'â€”'}</b></span>`:`Mean HI: <b>${isNum(avg) ? num3(avg) : 'â€”'}</b>`;return `Setup ${i + 1} â€¢ BS: <b>${bsRows.length}</b> â€¢ ${medPart} â€¢ ${avgPart}`});els.summary.innerHTML=lines.join('<br>')}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function exportAllPrintable(){const thr=state.meta.thresholds;const title=state.meta.title||'Field Book';const date=state.meta.date||todayISO();const fmt=v=>isNum(v)?num3(v):'â€”';const sections=state.setups.map((s,i)=>{const his=s.rows.filter(r=>r.type==='BS'&&isNum(r.hi)).map(r=>r.hi);const med=his.length?median(his):null;const avg=his.length?mean(his):null;const mode=s.useMedian?'Median':'Mean';const rowsHtml=s.rows.map(r=>{const tds=[];tds.push(`<td>${escapeHtml(r.station ?? '')}</td>`);tds.push(`<td>${r.type === 'BS' ? fmt(r.bs) : 'â€”'}</td>`);tds.push(`<td>${r.type === 'BS' ? fmt(r.hi) : 'â€”'}</td>`);tds.push(`<td>${r.type === 'FS' ? fmt(r.fs) : 'â€”'}</td>`);tds.push(`<td>${r.type === 'BS' ? fmt(r.knownElev) : (r.type === 'FS' ? fmt(r.elev) : 'â€”')}</td>`);let gpsHtml=r.type==='FS'?fmt(r.gps):'â€”';let cellStyle='';if(r.type==='FS'&&isNum(r.delta)){cellStyle=r.delta<=thr.green?' style="background:#dcfce7"':r.delta<=thr.yellow?' style="background:#fef3c7"':' style="background:#fee2e2"'}
tds.push(`<td${cellStyle}>${gpsHtml}</td>`);return `<tr>${tds.join('')}</tr>`}).join('');return `
            <section class="page">
                <h2>${escapeHtml(title)} â€” Setup ${i + 1}</h2>
                <div class="meta">
                <div><b>Date:</b> ${escapeHtml(date)}</div>
                <div><b>HI Mode:</b> ${mode}
                    &nbsp; <b>Median HI:</b> ${isNum(med) ? num3(med) : 'â€”'}
                    &nbsp; <b>Mean HI:</b> ${isNum(avg) ? num3(avg) : 'â€”'}</div>
                <div class="muted">GPS Î” thresholds: green â‰¤ ${num3(thr.green)} â€¢ yellow â‰¤ ${num3(thr.yellow)}</div>
                </div>
                <table>
                <thead><tr><th>STA</th><th>BS</th><th>HI</th><th>FS</th><th>ELEV</th><th>GPS</th></tr></thead>
                <tbody>${rowsHtml}</tbody>
                </table>
            </section>`}).join('');const html=`<!doctype html><html><head><meta charset="utf-8">
        <title>${escapeHtml(title)} â€” All Setups</title>
        <style>
            body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111;margin:24px;}
            h1,h2{margin:0 0 6px;}
            h2{font-size:18px;}
            .meta{margin:0 0 12px;color:#444}
            .muted{color:#555}
            table{width:100%;border-collapse:collapse;font-size:14px}
            th,td{border:1px solid #ccc;padding:6px 8px;text-align:left}
            th{background:#f3f4f6}
            .page{margin-bottom:24px;}
            @media print{
            body{margin:0.5in;}
            .page{page-break-after: always;}
            .page:last-of-type{page-break-after: auto;}
            button{display:none}
            }
        </style>
        </head>
        <body>
            <h1>${escapeHtml(title)} â€” All Setups</h1>
            ${sections}
            <button onclick="window.print()">Print / Save as PDF</button>
        </body></html>`;const win=window.open('','_blank');win.document.open();win.document.write(html);win.document.close()}
function saveState(andStatus){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));if(andStatus)setStatus('Saved');}catch(e){setStatus('Save failed');console.error(e)}}
function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return null;const s=JSON.parse(raw);if(!s?.meta?.appVersion||s.meta.appVersion!==APP_VERSION){try{localStorage.setItem(STORAGE_KEY+'_backup_'+Date.now(),raw)}catch(_){}
localStorage.removeItem(STORAGE_KEY);return null}
return s}catch(e){return null}}
function hardReset(){if(confirm('Reset all data?')){localStorage.removeItem(STORAGE_KEY);location.reload()}}
function openTools(){const sheet=els.toolsSheet;if(!sheet){console.warn('Tools sheet not found in HTML');return}
sheet.classList.remove('hidden');sheet.setAttribute('aria-hidden','false');try{const raw=localStorage.getItem(SLOPE_STORAGE_KEY);if(raw){const s=JSON.parse(raw);if(s){if(els.scDStart)els.scDStart.value=s.dStart??'';if(els.scDEnd)els.scDEnd.value=s.dEnd??'';if(els.scAStart)els.scAStart.value=s.aStart??'';if(els.scAEnd)els.scAEnd.value=s.aEnd??'';if(els.scLen)els.scLen.value=s.len??'';if(els.scStartSta)els.scStartSta.value=s.startSta??'';if(els.scEndSta)els.scEndSta.value=s.endSta??'';computeSlopeCheck()}}}catch(e){console.warn('Slope calc restore failed',e)}}
function closeTools(){const sheet=els.toolsSheet;if(!sheet){console.warn('Tools sheet not found in HTML');return}
sheet.classList.add('hidden');sheet.setAttribute('aria-hidden','true')}
function mmToMeters(raw){const str=String(raw??'').trim();const v=sanitizeNumber(str);if(v===null)return null;return/[.,]/.test(str)?v:v/1000}
function fmtRatioFromPercent(pct){if(!isNum(pct)||pct===0)return'â€”';const r=Math.round(100/Math.abs(pct));return `1 in ${r}`}
function computeSlopeCheck(){const dStart=mmToMeters(els.scDStart.value);const dEnd=mmToMeters(els.scDEnd.value);const aStart=mmToMeters(els.scAStart.value);const aEnd=mmToMeters(els.scAEnd.value);const lenRaw=String(els.scLen.value??'').trim();const len=sanitizeNumber(lenRaw);const dPct=(isNum(dStart)&&isNum(dEnd)&&isNum(len)&&len!==0)?((dEnd-dStart)/len)*100:null;const aPct=(isNum(aStart)&&isNum(aEnd)&&isNum(len)&&len!==0)?((aEnd-aStart)/len)*100:null;const dPctTxt=isNum(dPct)?`${num3(dPct)}%`:'â€”';const aPctTxt=isNum(aPct)?`${num3(aPct)}%`:'â€”';const dRatio=fmtRatioFromPercent(dPct);const aRatio=fmtRatioFromPercent(aPct);const deltaPct=(isNum(dPct)&&isNum(aPct))?(aPct-dPct):null;const deltaEnd=(isNum(aEnd)&&isNum(dEnd))?(aEnd-dEnd):null;const deltaStart=(isNum(aStart)&&isNum(dStart))?(aStart-dStart):null;const thr={green:0.05,yellow:0.10};let deltaClass='';if(isNum(deltaPct)){deltaClass=Math.abs(deltaPct)<=thr.green?'qa-green':Math.abs(deltaPct)<=thr.yellow?'qa-yellow':'qa-red'}
const deltaPctTxt=isNum(deltaPct)?`${num3(deltaPct)}%`:'â€”';const deltaEndTxt=isNum(deltaEnd)?`${num3(deltaEnd)} m`:'â€”';els.scResults.innerHTML=`
            <div><b>Design Slope:</b> ${dPctTxt} &nbsp; <span class="muted">(${dRatio})</span></div>
            <div><b>ASB Slope:</b> ${aPctTxt} &nbsp; <span class="muted">(${aRatio})</span></div>
            <div><b>Î” Slope:</b> <span class="${deltaClass}">${deltaPctTxt}</span></div>
            <div><b>Î” Start:</b> ${isNum(deltaStart) ? deltaMmText(aStart, dStart) : 'â€”'}</div>
            <div><b>Î” End:</b> ${isNum(deltaEnd) ? deltaMmText(aEnd, dEnd) : 'â€”'}</div>
            `;try{localStorage.setItem(SLOPE_STORAGE_KEY,JSON.stringify({dStart,dEnd,aStart,aEnd,len,startSta:els.scStartSta?.value??'',endSta:els.scEndSta?.value??''}))}catch(e){console.warn('Slope calc save failed',e)}}
function clearSlopeCheck(){[els.scStartSta,els.scEndSta,els.scDStart,els.scDEnd,els.scAStart,els.scAEnd,els.scLen].forEach(i=>i&&(i.value=''));els.scResults.innerHTML='';try{localStorage.removeItem(SLOPE_STORAGE_KEY)}catch(e){}}
function byId(id){return document.getElementById(id)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function uid(){return Math.random().toString(36).slice(2,9)}
function isNum(v){return typeof v==='number'&&isFinite(v)}
function round3(v){return Math.round(v*1000)/1000}
function num3(v){return(Math.round(v*1000)/1000).toFixed(3)}
function mean(a){return a.length?a.reduce((s,x)=>s+x,0)/a.length:null}
function median(a){if(!a.length)return null;const b=[...a].sort((x,y)=>x-y);const m=Math.floor(b.length/2);return b.length%2?b[m]:(b[m-1]+b[m])/2}
function sanitizeNumber(str){if(str==null)return null;let s=String(str).trim();if(!s)return null;s=s.replace(',','.');const cleaned=s.replace(/[^0-9+\-\.]/g,'');if(cleaned===''||cleaned==='-'||cleaned==='.'||cleaned==='+')return null;const n=Number(cleaned);return isFinite(n)?n:null}
function setStatus(msg){toast(msg)}
function flash(msg){toast(msg)}
function deltaMmText(asb,design){if(!isNum(asb)||!isNum(design))return'â€”';const mm=Math.round((asb-design)*1000);if(mm===0)return `<span class="delta-zero">0 mm OK</span>`;const cls=mm>0?'delta-up':'delta-down';const arrow=mm>0?'â–²':'â–¼';return `<span class="${cls}">${Math.abs(mm)} mm ${arrow}</span>`}
function openBsPicker(){const options=gatherElevStations();if(!options.length){toast('No prior stations with elevation found');return}
els.bsPickerList.className='bs-grid';els.bsPickerList.innerHTML=options.map(opt=>`
            <button class="bs-btn" 
                    data-station="${escapeHtml(opt.station)}" 
                    data-elev="${opt.elev}">
            <div>${escapeHtml(opt.station || '(no STA)')}</div>
            <span class="bs-meta">Elev ${num3(opt.elev)} â€¢ Setup ${opt.setup + 1} â€¢ ${opt.source}</span>
            </button>
        `).join('');els.bsPickerSheet.classList.remove('hidden');els.bsPickerSheet.setAttribute('aria-hidden','false')}
function closeBsPicker(){els.bsPickerSheet.classList.add('hidden');els.bsPickerSheet.setAttribute('aria-hidden','true')}
function gatherElevStations(){const out=[];state.setups.forEach((s,si)=>{if(si>=state.active)return;s.rows.forEach((r,ri)=>{if(r.type==='BS'&&isNum(r.knownElev)){out.push({setup:si,index:ri,station:r.station||'',elev:r.knownElev,source:'BS'})}
if(r.type==='FS'&&isNum(r.elev)){out.push({setup:si,index:ri,station:r.station||'',elev:r.elev,source:'FS'})}})});out.sort((a,b)=>(b.setup-a.setup)||(a.index-b.index));return out}
function insertBsFromPicker(){const checked=document.querySelector('input[name="bsPick"]:checked');if(!checked){flash('Select a station first');return}
const station=checked.getAttribute('data-station')||'';const elevStr=checked.getAttribute('data-elev');const elev=sanitizeNumber(elevStr);const s=activeSetup();if(s.locked){flash('Setup is locked');return}
s.rows.splice(0,0,{id:uid(),type:'BS',station:station,knownElev:isNum(elev)?elev:null,bs:null,hi:null});recompute(s);render();saveState();closeBsPicker();flash('Existing BS added')}
function insertBsFromData(station,elev){const s=activeSetup();if(s.locked)return toast('Setup is locked');s.rows.splice(0,0,{id:uid(),type:'BS',station:station||'',knownElev:isNum(elev)?elev:null,bs:null,hi:null});recompute(s);render();saveState();closeBsPicker();toast('Existing BS added')}
function mmToMeters(raw){const str=String(raw??'').trim();const v=sanitizeNumber(str);if(v===null)return null;return/[.,]/.test(str)?v:v/1000}
function readSlcInputs(){const start=mmToMeters(els.slcStart?.value);const end=mmToMeters(els.slcEnd?.value);const slope=sanitizeNumber((els.slcSlope?.value??'').trim());const len=sanitizeNumber((els.slcLen?.value??'').trim());return{start,end,slope,len}}
function countProvided(obj){return Object.values(obj).reduce((n,v)=>n+(isNum(v)?1:0),0)}
function computeSlopeSolve(){const bottom=mmToMeters(els.slcStart?.value);const top=mmToMeters(els.slcEnd?.value);const slope=sanitizeNumber((els.slcSlope?.value??'').trim());const len=sanitizeNumber((els.slcLen?.value??'').trim());const provided={bottom,top,slope,len};const n=Object.values(provided).reduce((c,v)=>c+(isNum(v)?1:0),0);if(n<3){els.slcResults.innerHTML='';toast('Provide any 3 fields; 1 will be solved');return}
if(n>3){els.slcResults.innerHTML='';toast('Please leave exactly 1 field blank');return}
let solved={bottom,top,slope,len};let solvedKey=null;if(!isNum(bottom)&&isNum(top)&&isNum(slope)&&isNum(len)&&len!==0){solved.bottom=top-(slope/100)*len;solvedKey='bottom'}else if(!isNum(top)&&isNum(bottom)&&isNum(slope)&&isNum(len)&&len!==0){solved.top=bottom+(slope/100)*len;solvedKey='top'}else if(!isNum(slope)&&isNum(bottom)&&isNum(top)&&isNum(len)&&len!==0){solved.slope=((top-bottom)/len)*100;solvedKey='slope'}else if(!isNum(len)&&isNum(bottom)&&isNum(top)&&isNum(slope)&&slope!==0){solved.len=(top-bottom)/(slope/100);solvedKey='len'}else{els.slcResults.innerHTML='';toast('Inputs inconsistent (check zero length or zero slope)');return}
const fmtM=v=>isNum(v)?`${num3(v)} m`:'â€”';const fmtP=v=>isNum(v)?`${num3(v)}%`:'â€”';const bold=(k,txt)=>(solvedKey===k?`<b>${txt}</b>`:txt);els.slcResults.innerHTML=`
            <div>${bold('bottom', `Bottom Elev:${fmtM(solved.bottom)}`)}</div>
            <div>${bold('top', `Top Elev:${fmtM(solved.top)}`)}</div>
            <div>${bold('slope', `Slope:${fmtP(solved.slope)}`)}</div>
            <div>${bold('len', `Length:${fmtM(solved.len)}`)}</div>
        `}
function clearSlopeSolve(){[els.slcStart,els.slcEnd,els.slcSlope,els.slcLen].forEach(i=>i&&(i.value=''));els.slcResults.innerHTML=''}
function loadGradeSpots(){try{const raw=localStorage.getItem(GRADE_SPOTS_KEY);if(raw){const rows=JSON.parse(raw);if(Array.isArray(rows))state.gradeSpots=rows}}catch(e){}
try{const raw=localStorage.getItem(INV_DROP_KEY);if(raw){const drop=JSON.parse(raw);if(isNum(drop)&&els.invDrop)els.invDrop.value=String(drop);}}catch(e){}}
function saveGradeSpots(){try{localStorage.setItem(GRADE_SPOTS_KEY,JSON.stringify(state.gradeSpots))}catch(e){}}
function addGradeRow(){state.gradeSpots.push({sta:'',dInv:null,asbTop:null})}
function renderGradeSpots(){if(!els.gradeSpotsBody)return;if(!Array.isArray(state.gradeSpots))state.gradeSpots=[];const drop=sanitizeNumber((els.invDrop?.value??'').trim());els.gradeSpotsBody.innerHTML='';state.gradeSpots.forEach((r,i)=>{const tr=document.createElement('tr');tr.appendChild(cellEditText(r,'sta',r.sta,v=>{r.sta=v;saveGradeSpots()}));tr.appendChild(cellEditNumber(r,'dInv',r.dInv,v=>{r.dInv=v;saveGradeSpots();renderGradeSpots()},!0));const tdTop=document.createElement('td');tdTop.className='cell-edit';tdTop.style.display='flex';tdTop.style.flexDirection='column';tdTop.style.alignItems='center';tdTop.style.padding='4px';const inpTop=document.createElement('input');inpTop.type='text';inpTop.className='cell-input cell-input--manual';inpTop.inputMode='decimal';inpTop.value=isNum(r.asbTop)?String(r.asbTop):(r.asbTop??'');inpTop.addEventListener('blur',()=>{const raw=inpTop.value.trim();const n=mmToMeters(raw);r.asbTop=n;saveGradeSpots();renderGradeSpots()});tdTop.appendChild(inpTop);const calcLine=document.createElement('div');calcLine.className='mini-hint';if(isNum(r.asbTop)&&isNum(drop)){const newInv=r.asbTop-drop;calcLine.innerHTML=`âˆ’ ${num3(drop)} = <b>${num3(newInv)}</b>`}else{calcLine.textContent='invert â€”'}
tdTop.appendChild(calcLine);const pickBtn=document.createElement('button');pickBtn.type='button';pickBtn.textContent='Pick';pickBtn.style.cssText='margin: 2px 0px 2px; padding:4px 18px;width:auto;font-size: 8px;';pickBtn.addEventListener('click',()=>openAsbPicker(i));tdTop.appendChild(pickBtn);tr.appendChild(tdTop);const tdDelta=document.createElement('td');tdDelta.className='cell-calc';let html='â€”';if(isNum(r.dInv)&&isNum(r.asbTop)&&isNum(drop)){const asbInv=r.asbTop-drop;html=deltaMmText(asbInv,r.dInv)}
tdDelta.innerHTML=html;tr.appendChild(tdDelta);els.gradeSpotsBody.appendChild(tr)})}
function cellEditText(row,field,value,onCommit){const td=document.createElement('td');td.className='cell-edit';const inp=document.createElement('input');inp.type='text';inp.className='cell-input';inp.inputMode='text';inp.value=(value??' ').toString();inp.addEventListener('blur',()=>onCommit(inp.value.trim()));td.appendChild(inp);return td}
function cellEditNumber(row,field,value,onCommit,allowMmShorthand){const td=document.createElement('td');td.className='cell-edit';const inp=document.createElement('input');inp.type='text';inp.className='cell-input cell-input--manual';inp.inputMode='decimal';inp.value=isNum(value)?String(value):(value??'');inp.addEventListener('blur',()=>{const raw=inp.value.trim();const n=allowMmShorthand?mmToMeters(raw):sanitizeNumber(raw);onCommit(n);renderGradeSpots()});td.appendChild(inp);return td}
function openGradeSpots(){els.gradeSpotsSheet.classList.remove('hidden');els.gradeSpotsSheet.setAttribute('aria-hidden','false');loadGradeSpots();renderGradeSpots()}
function closeGradeSpots(){els.gradeSpotsSheet.classList.add('hidden');els.gradeSpotsSheet.setAttribute('aria-hidden','true')}
let _gradeSpotTargetIndex=-1;function openAsbPicker(targetIndex){_gradeSpotTargetIndex=targetIndex;const options=gatherAsbElevStations();if(!options.length){return toast('No stations with elevation found')}
els.asbPickerList.className='bs-grid';els.asbPickerList.innerHTML=options.map(opt=>`
    <button class="bs-btn"
            data-target-index="${_gradeSpotTargetIndex}"
            data-station="${escapeHtml(opt.station)}"
            data-elev="${opt.elev}">
      <div>${escapeHtml(opt.station || '(no STA)')}</div>
      <span class="bs-meta">Elev ${num3(opt.elev)} â€¢ Setup ${opt.setup + 1} â€¢ ${opt.source}</span>
    </button>
  `).join('');els.asbPickerSheet.classList.remove('hidden');els.asbPickerSheet.setAttribute('aria-hidden','false')}
function closeAsbPicker(){els.asbPickerSheet.classList.add('hidden');els.asbPickerSheet.setAttribute('aria-hidden','true');_gradeSpotTargetIndex=-1}
function gatherAsbElevStations(){const out=[];state.setups.forEach((s,si)=>{s.rows.forEach((r,ri)=>{if(r.type==='FS'&&isNum(r.elev)){out.push({setup:si,index:ri,station:r.station||'',elev:r.elev,source:'FS Elev'})}
if(r.type==='BS'&&isNum(r.knownElev)){out.push({setup:si,index:ri,station:r.station||'',elev:r.knownElev,source:'BS Known'})}})});out.sort((a,b)=>(b.setup-a.setup)||(a.index-b.index));return out}})()